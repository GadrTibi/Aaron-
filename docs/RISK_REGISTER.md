| ID | Catégorie | Risque | Où dans le code | Symptôme côté user | Cause racine probable | Gravité | Correctif recommandé | Test de non-régression proposé |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| R1 | Fiabilité | Absence de clés API désactive la recherche de lieux (Google Places) et réduit l’automatisme transports | `app/views/estimation.py` lignes 107-151 ; `services/transports_v3.py` lignes 158-214 | Listes POI vides, messages “Clé Google manquante”, générateurs de documents incomplets | Clé `GOOGLE_MAPS_API_KEY` non fournie ou invalide | P1 | Ajouter une alerte bloquante avant génération si aucune clé n’est disponible et fournir un fallback OSM/Geoapify activé par défaut | Test Streamlit e2e simulant absence de clé et vérifiant que le bouton de génération refuse avec un message clair |
| R2 | Architecture | Dépendance forte à des templates externes : absence ou nommage différent des shapes/tokens bloque la génération PPTX/DOCX | `app/services/template_validation.py` ; `app/services/pptx_requirements.py` ; `app/views/estimation.py` lignes 96-190 & 337-375 ; `app/views/mandat.py` lignes 17-126 ; `app/views/book.py` lignes 22-184 | Erreurs “template introuvable” ou images non injectées ; tokens non remplacés dans les exports | Templates manquants dans `EST_TPL_DIR`/`MANDAT_TPL_DIR`/`BOOK_TPL_DIR` ou noms de shapes différents des attentes (`*_MASK`, tokens « … ») | P1 | Validation préflight des tokens/shapes dès la sélection + checklist UI ; mode strict bloque la génération en cas de KO | Tests unitaires `tests/test_template_validation_docx.py` et `tests/test_template_validation_pptx.py` créant des templates minimaux et vérifiant les alertes |
| R3 | Sécurité | Clés API stockées en clair dans `~/.mfy_local_app/secrets.toml` sans chiffrement ni permissions renforcées | `app/views/settings_keys.py` lignes 56-79 | Exfiltration de clés si le poste est partagé ou sauvegardé sans protection | Fichier texte world-readable créé par défaut, aucune restriction d’ACL | P2 | Forcer les permissions `0o600` lors de l’écriture du fichier de secrets et documenter l’usage d’un gestionnaire de secrets chiffré | Test unitaire vérifiant que le fichier créé par `write_local_secret` a des permissions restreintes et que la valeur est lisible |
| R4 | Maintenance | Absence de purge sur caches/images/logs pouvant saturer le disque à l’usage (out/, logs/) | `config/places_settings.py` lignes 33-64 ; `app/services/image_fetcher.py` lignes 15-69 | L’app devient lente ou échoue pour cause d’espace disque | Aucun mécanisme de rotation ou cleanup, TTL seulement pour les métadonnées cache | P2 | Ajouter une tâche de nettoyage (au démarrage ou via bouton “Nettoyer les caches”) supprimant les fichiers âgés/volumineux | Test scripté créant des fichiers factices dans `out/cache` et vérifiant qu’ils sont supprimés après l’appel de la routine de cleanup |
| R5 | UX | Erreurs silencieuses ou logs console non visibles dans l’UI lors de l’injection PPTX/DOCX (tokens restants, images manquantes) | `app/services/generation_report.py` ; `app/services/docx_fill.py` ; `app/services/pptx_fill.py` ; `app/views/*.py` | L’utilisateur croit que le document est complet alors que des tokens restent ou des images manquent | Les warnings sont imprimés en console (stdout) sans retour Streamlit | P2 | Centraliser un `GenerationReport` et l’afficher dans l’UI (expander + warning/error), en listant tokens/shapes/images manquants et les avertissements réseau | Tests unitaires simulant tokens/shape manquants et vérifiant que le rapport les expose |
